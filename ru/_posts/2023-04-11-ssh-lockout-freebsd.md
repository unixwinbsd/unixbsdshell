---
title: Учебник SSHLOCKOUT для OpenBSD
date: "2023-04-11 11:00:00 +0300"
id: ssh-lockout-freebsd
lang: ru
layout: single
author_profile: true
categories:
  - OpenBSD
tags: "UnixShell"
excerpt: "Эта функция обеспечивает управление на уровне пользователя, позволяя запретить вход по SSH в целом"
keywords: ssh, oepnssh, freebsd, server, openbsd, configuration, security
---

Модуль SSH Lockout позволяет администраторам ограничивать доступ к среде через SSH. Эта функция обеспечивает механизм, гарантирующий доступность ресурсов обработки для высокоприоритетных задач, и помогает управлять плановым обслуживанием. Обратите внимание, что блокировка не влияет на существующие входы по SSH. Блокировка предотвращает только новые входы по SSH. Доступ к программному обеспечению, не использующему SSH, не затрагивается.

Эта функция обеспечивает управление на уровне пользователя, позволяя запретить вход по SSH в целом, но при этом разрешить вход по SSH из определенных учетных записей пользователей. Этот уровень контроля доступен в зависимости от того, как вы настроили элементы управления блокировкой. На следующем изображении показаны поля, доступные на вкладке «Белый список блокировки».

Программа sshlockout — это дополнительный уровень безопасности, который блокирует IP-адреса, достигшие максимального порога неудачных попыток ввода пароля. Программа sshlockout изначально была разработана в DragonFlyBSD и перенесена в OpenBSD. Если вы из мира Linux, то это похоже на Fail2Ban и это очень простая программа. Если sshlockout настроен с помощью настроек на странице руководства, то любой IP-адрес, для которого будет совершено более 5 неверных попыток ввода пароля, будет заблокирован в течение одного часа. Затем блокировка IP-адреса истечет через 1 день, и будет разрешено попытаться войти снова.

## 1. Что такое sshlockout
Ниже представлен краткий обзор sshlockout и того, как эффективно использовать его для блокировки злоумышленников на машине OpenBSD.

Программа sshlockout — это дополнительный уровень безопасности, который блокирует IP-адреса, достигшие максимального порога неудачных попыток ввода пароля. Программа sshlockout изначально была разработана в DragonFlyBSD и перенесена в OpenBSD. Если вы из мира Linux, эта программа похожа на Fail2Ban и является очень простой программой. ​

Если sshlockout настроен с использованием параметров на странице руководства, программа заблокирует любой IP-адрес, для которого будет совершено более 5 неверных попыток ввода пароля в течение часа. Заблокированные IP-адреса по умолчанию блокируются на один день, после чего им разрешается повторная попытка входа в систему.

Прежде чем настраивать sshlockout, я НАСТОЯТЕЛЬНО рекомендую следующее:
- Создайте ключ RSA для аутентификации SSH.
- Отключить аутентификацию по паролю SSH.
- Отключить аутентификацию root по SSH.
- Измените порт SSH по умолчанию.
- После того, как все эти задачи выполнены, наступает время установки!

## 2. Установка и настройка SSHLockout
Первоначальная установка выполняется с помощью менеджера пакетов OpenBSD от имени пользователя root или с привилегиями root с помощью команды:

```
hostname1# pkg_add sshlockout
```

Чтобы установить правильные разрешения, отредактируйте /etc/doas.conf и добавьте следующее:

```
hostname1# permit nopass _syslogd as root cmd /usr/sbin/sshlockout
```

Теперь, когда sshlockout установлен, требуется его настройка. Вам необходимо добавить таблицу PF и правило для блокировки этой таблицы. Отредактируйте нижнюю часть /etc/pf.conf следующим образом:

```
hostname1# table <lockout> persist
hostname1# block in quick on egress proto tcp from <lockout> to port 22
```

Чтобы протестировать и применить новые таблицы и правила PF, выполните следующие команды:

```
hostname1# pf -n -f /etc/pf.conf && pfctl -f /etc/pf.conf
```

Затем вы редактируете /etc/syslog.conf и для целей ведения журнала добавляете следующее:

```
auth.info;authpriv.info | exec /usr/bin/doas -n /usr/local/sbin/sshlockout -pf "lockout"
```

Заключительная часть sshlockout — добавление строки в crontab пользователя root для удаления заблокированных IP-адресов. Выполните следующие команды:

```
hostname1# doas crontab -e
```

После этого вы добавляете следующую строку в crontab пользователя root:

```
3 3 * * * pfctl -tlockout -T expire 4294967295
```

Установленное число для истечения срока действия указывается в секундах. Измените желаемый период времени для блокировки вредоносных публичных IP-адресов.

## 3. Тестирование SSH-блокировки
Один из способов проверить работу sshlockout — попробовать войти с другого IP-адреса. Вы можете использовать VPN для подключения к серверу и переместить свои ключи SSH в другой каталог, чтобы команда SSH не использовала их. Затем вы можете попробовать подключиться к своему серверу по SSH, используя случайные учетные данные. После 5 неудачных попыток использования SSH сервер зависнет вместо того, чтобы запросить учетные данные. Чтобы преодолеть эту проблему, необходимо вмешательство пользователя путем нажатия Ctrl+C.

После блокировки вам следует проверить свой публичный IP-адрес, пока ваше VPN-подключение активно. Затем отключитесь от VPN и переместите ключ RSA обратно в ~/.ssh. Теперь вы можете подключиться по ssh к удаленному веб-серверу и выполнить команду:

```
hostname1# pfctl -t lockout -T show | grep your.vpn.ip.address
```

Теперь он вернет IP-адрес VPN, подтверждающий, что VPN добавлен в черный список.
